# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET

jobs:
  build:

    on:
      push:
        branches: [ "dev" ]
      pull_request:
        branches: [ "dev" ]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 7.0.x
    - name: Build & test
      run: dotnet fsi build.fsx -- -- build test

  publish:

    on:
      tags:
        - 'v*'

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 7.0.x
    - name: Build and test
      run: dotnet fsi build.fsx -- -- build test
    - name: Publish
      run: dotnet fsi build.fsx -- -- pack push
      env:
        VER: $(if [[ "${GITHUB_REF_NAME:0:1}" == "v" ]]; then echo ${GITHUB_REF_NAME:1}.${{github.run_number}}; else echo 1.0.0.${{github.run_number}}; fi;)
        NUGET_KEY: ${{ secrets.NUGET_API_KEY }}
